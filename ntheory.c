#include "object.h"
int prime_list[] = {2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97, \
                    101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,\
                    193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,\
                    293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,\
                    409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,\
                    521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,\
                    641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,\
                    757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,\
                    881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997,1009,\
                    1013,1019,1021,1031,1033,1039,1049,1051,1061,1063,1069,1087,1091,1093,1097,\
                    1103,1109,1117,1123,1129,1151,1153,1163,1171,1181,1187,1193,1201,1213,1217,\
                    1223,1229,1231,1237,1249,1259,1277,1279,1283,1289,1291,1297,1301,1303,1307,\
                    1319,1321,1327,1361,1367,1373,1381,1399,1409,1423,1427,1429,1433,1439,1447,\
                    1451,1453,1459,1471,1481,1483,1487,1489,1493,1499,1511,1523,1531,1543,1549,\
                    1553,1559,1567,1571,1579,1583,1597,1601,1607,1609,1613,1619,1621,1627,1637,\
                    1657,1663,1667,1669,1693,1697,1699,1709,1721,1723,1733,1741,1747,1753,1759,\
                    1777,1783,1787,1789,1801,1811,1823,1831,1847,1861,1867,1871,1873,1877,1879,\
                    1889,1901,1907,1913,1931,1933,1949,1951,1973,1979,1987,1993,1997,1999,2003,\
                    2011,2017,2027,2029,2039,2053,2063,2069,2081,2083,2087,2089,2099,2111,2113,\
                    2129,2131,2137,2141,2143,2153,2161,2179,2203,2207,2213,2221,2237,2239,2243,\
                    2251,2267,2269,2273,2281,2287,2293,2297,2309,0    };

int devid_list[] = {1,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,
                    113,127,131,137,139,149,151,157,163,167,169,173,179,181,191,193,197,199,211,221,
                    223,227,229,233,239,241,247,251,257,263,269,271,277,281,283,289,293,299,307,311,
                    313,317,323,331,337,347,349,353,359,361,367,373,377,379,383,389,391,397,401,403,
                    409,419,421,431,433,437,439,443,449,457,461,463,467,479,481,487,491,493,499,503,
                    509,521,523,527,529,533,541,547,551,557,559,563,569,571,577,587,589,593,599,601,
                    607,611,613,617,619,629,631,641,643,647,653,659,661,667,673,677,683,689,691,697,
                    701,703,709,713,719,727,731,733,739,743,751,757,761,767,769,773,779,787,793,797,
                    799,809,811,817,821,823,827,829,839,841,851,853,857,859,863,871,877,881,883,887,
                    893,899,901,907,911,919,923,929,937,941,943,947,949,953,961,967,971,977,983,989,
                    991,997,1003,1007,1009,1013,1019,1021,1027,1031,1033,1037,1039,1049,1051,1061,1063,
                    1069,1073,1079,1081,1087,1091,1093,1097,1103,1109,1117,1121,1123,1129,1139,1147,1151,
                    1153,1157,1159,1163,1171,1181,1187,1189,1193,1201,1207,1213,1217,1219,1223,1229,1231,
                    1237,1241,1247,1249,1259,1261,1271,1273,1277,1279,1283,1289,1291,1297,1301,1303,1307,
                    1313,1319,1321,1327,1333,1339,1343,1349,1357,1361,1363,1367,1369,1373,1381,1387,1391,
                    1399,1403,1409,1411,1417,1423,1427,1429,1433,1439,1447,1451,1453,1457,1459,1469,1471,
                    1481,1483,1487,1489,1493,1499,1501,1511,1513,1517,1523,1531,1537,1541,1543,1549,1553,
                    1559,1567,1571,1577,1579,1583,1591,1597,1601,1607,1609,1613,1619,1621,1627,1633,1637,
                    1643,1649,1651,1657,1663,1667,1669,1679,1681,1691,1693,1697,1699,1703,1709,1711,1717,
                    1721,1723,1733,1739,1741,1747,1751,1753,1759,1763,1769,1777,1781,1783,1787,1789,1801,
                    1807,1811,1817,1819,1823,1829,1831,1843,1847,1849,1853,1861,1867,1871,1873,1877,1879,
                    1889,1891,1901,1907,1909,1913,1919,1921,1927,1931,1933,1937,1943,1949,1951,1957,1961,
                    1963,1973,1979,1987,1993,1997,1999,2003,2011,2017,2021,2027,2029,2033,2039,2041,2047,
                    2053,2059,2063,2069,2071,2077,2081,2083,2087,2089,2099,2111,2113,2117,2119,2129,2131,
                    2137,2141,2143,2147,2153,2159,2161,2171,2173,2179,2183,2197,2201,2203,2207,2209,2213,
                    2221,2227,2231,2237,2239,2243,2249,2251,2257,2263,2267,2269,2273,2279,2281,2287,2291,
                    2293,2297,2309,0   };
#define MAX_K 2*3*5*7*11    // = 2310
Vector * trial_div(mpz_t m) {
    Vector * factor_list = vector_init(100);
    int count  = 0; int p;
    mpz_t q, r; mpz_init(q); mpz_init(r);
    mpz_t sq; mpz_init(sq);
    mpz_ptr n = (mpz_ptr)malloc(sizeof(MP_INT)); mpz_init_set(n,m);
    while (TRUE) {
        //if (mpz_probab_prime_p(n,20) != 0) {push(factor_list, (void*)newLINT(n));return factor_list;}
        // 2310以下は素数リスト(prime_list[])で割る
        int i = 0; int ith_prime;p = FALSE; 
        mpz_sqrt(sq, n);mpz_get_si(sq); 
        while ((ith_prime = prime_list[i ++ ]) != 0) {
            if (mpz_cmp_ui(n, 1) ==0)  return factor_list; 
            if (mpz_cmp_ui(sq, ith_prime) < 0) {push(factor_list,(void*)newLINT(n));return factor_list ;}
            mpz_fdiv_qr_ui(q, r, n, ith_prime); 
            if (mpz_cmp_ui(r, 0) == 0) {
                push(factor_list, (void*)newINT(ith_prime)); 
                mpz_set(n, q);
                p = TRUE ;
                break;   
            }
        }
        if (p) continue;
        // 2310以上は2,3,5,7,11の倍数を除いた数(2310*n+devid_list[])で割る
        //unsigned long k=2310,ith_div;
        if (mpz_probab_prime_p(n,20) != 0) {push(factor_list, (void*)newLINT(n));return factor_list;}
        unsigned long ith_div;
        //while (TRUE) {
        for(unsigned long k=MAX_K;k<MAX_K*100000L;k+=MAX_K) {
            i=0;p=FALSE;
            while ((ith_div = devid_list[i++]) != 0) {
                ith_div+=k;//printf("n: %lu devid: %lu",n,ith_dev);
                if (mpz_cmp_ui(sq, ith_div) < 0) {push(factor_list, (void*)newLINT(n));return factor_list;}
                mpz_fdiv_qr_ui(q, r, n, ith_div);
                if (mpz_cmp_ui(r, 0) == 0) {
                    push(factor_list, (void*)newINT(ith_div));
                    mpz_set(n, q);
                    p=TRUE;
                    break;}
            }
            //k += 2310;
            if (p) break;
        }
        if (p) continue;
        push(factor_list, (void*)newLINT(n));return factor_list; 
    }
}
//   fermat : fermat法を使い素因数分解を行う
//
//   n 素因数分解を行う対象の数
//   a 発見された因数
//
void fermat(mpz_t n, mpz_t a) {
    mpz_t b2; mpz_init(b2);
    if (mpz_tstbit(n,0) ==0)                // nが偶数の時fermat法は止まらない
        {mpz_set_ui(a,2);
        return;}
    mpz_sqrt(a, n);                         // a=√n
    mpz_mul(b2,a,a); mpz_sub(b2,b2,n);      // b2=a*a-n
    while (mpz_perfect_square_p(b2) ==0 ) { // b2が平方数でない限り
        mpz_add_ui(a,a,1);                  // a =a+1
        mpz_mul(b2,a,a); mpz_sub(b2, b2, n);// b2 =a*a-n
    }
    mpz_sqrt(b2,b2);mpz_sub(a,a,b2);        // a=a-√b2
}
//   pollard_pm1 : ポラードの p-1 法を使い素因数分解を行う
//
//   n 素因数分解を行う対象の数
//   g 発見された因数
//   b 底(初期値として与える)
//   maxC 最大処理回数(指数の最大値 + 1)
//
//   戻り値 : 素因数分解に成功したらTRUEを返す
int pollard_pm1(mpz_t n, mpz_t g, unsigned long b, unsigned long maxC ) {
    mpz_t m; mpz_init_set_ui(m, b); 
    mpz_t mm1; mpz_init(mm1); 

    for ( unsigned long c = 0 ; c < maxC ; ++c ) {
        mpz_powm_ui(m, m, c + 1, n); 
        mpz_sub_ui(mm1, m, 1); 
        mpz_gcd(g, mm1, n); 
        if (mpz_cmp_ui(g, 1) == 0) continue; 
        if (mpz_cmp(g, n) == 0) return FALSE; 
        return TRUE;
    }
    return FALSE;
}
//   pollard_rho : ポラードのロー 法を使い素因数分解を行う
//
//   n 素因数分解を行う対象の数
//   d 発見された因数
//   x 初期値
//   cc 関数の初期パラメータ
//   max  最大処理回数
//   maxC 最大関数変更回数
//
//   戻り値 : 素因数分解に成功したらTRUEを返す
int pollard_rho(mpz_t n, mpz_t d, mpz_t x, mpz_t cc, unsigned long max, unsigned long maxc) {
    mpz_t y;mpz_init_set(y, x);;
    unsigned long trial, c;
    mpz_set_ui(d,1);
    for( c=1;c <=maxc; c++) {
        trial = 0;
        while (mpz_cmp_ui(d,1)==0 &&  trial++ < max ) {
            mpz_mul(x,x,x);mpz_add(x,x,cc);mpz_tdiv_r(x,x,n);
            mpz_mul(y,y,y);mpz_add(y,y,cc);mpz_tdiv_r(y,y,n);
            mpz_mul(y,y,y);mpz_add(y,y,cc);mpz_tdiv_r(y,y,n);
            mpz_sub(d,x,y);mpz_abs(d,d);
            mpz_gcd(d,d,n);
        }
        if (mpz_cmp(d,n) != 0 && trial<max) return TRUE;
        mpz_urandomm(cc,  RAND_STATE, n);
        mpz_urandomm(x,  RAND_STATE, n);
    }
    return FALSE;
}
